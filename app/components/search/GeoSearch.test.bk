// GeoSearch.test.tsx
import { Map } from "maplibre-gl";
import { render, screen } from "@testing-library/react";
import { afterEach, describe, it, expect, vi, beforeEach } from "vitest";
import GeoSearch from "./GeoSearch";
import { MapContext } from "~/contexts";
import type { ESPlace } from "~/esTypes";

// --- mocks ---
vi.mock("react-instantsearch", () => ({
  useGeoSearch: vi.fn(),
}));

vi.mock("~/utils/toFeatureCollection", () => ({
  hitsToFeatureCollection: vi.fn(() => ({
    type: "FeatureCollection",
    features: [
      {
        type: "Feature",
        geometry: { type: "Point", coordinates: [0, 0] },
        properties: { id: "1" },
      },
    ],
  })),
}));

vi.mock("./GeoSearchClusters", () => ({
  default: ({ geojson }: ESPlace) => (
    <div data-testid="clusters">Clusters: {JSON.stringify(geojson)}</div>
  ),
}));

vi.mock("./GeoSearchPoints", () => ({
  default: ({ geojson }: ESPlace) => (
    <div data-testid="points">Points: {JSON.stringify(geojson)}</div>
  ),
}));

const mockFitBounds = vi.fn();
const mockMap = new Map({ container: "map-container" });

const { useGeoSearch } = await vi.importMock<any>("react-instantsearch");

describe("GeoSearch component", () => {
  let container: HTMLDivElement;
  beforeEach(() => {
    vi.clearAllMocks();
    // Create a mock container element for each test
    container = document.createElement("div");
    container.id = "map-container";
    document.body.appendChild(container);

    // Mock the element's clientWidth and clientHeight using `Object.defineProperty`
    Object.defineProperty(container, "clientWidth", { value: 500 });
    Object.defineProperty(container, "clientHeight", { value: 500 });
  });

  afterEach(() => {
    // Clean up the mock container after each test
    document.body.removeChild(container);
  });

  it("renders nothing when no items and no geojson", () => {
    useGeoSearch.mockReturnValue({ items: [] });
    const { container } = render(
      <MapContext.Provider
        value={{
          map: undefined,
          setMap: () => {},
          mapLoaded: false,
          setMapLoaded: () => {},
        }}
      >
        <GeoSearch />
      </MapContext.Provider>
    );
    expect(container.firstChild).toBe(screen.getByTestId("clusters"));
  });

  it("renders clusters and points when geojson is created", () => {
    useGeoSearch.mockReturnValue({
      items: [{ objectID: "1", _geoloc: { lat: 0, lng: 0 } }],
    });

    const { container } = render(
      <MapContext.Provider
        value={{
          map: mockMap,
          setMap: () => {},
          mapLoaded: false,
          setMapLoaded: () => {},
        }}
      >
        <GeoSearch />
      </MapContext.Provider>
    );

    expect(screen.getByTestId("clusters")).toBeInTheDocument();
    expect(screen.getByTestId("points")).toBeInTheDocument();

    // snapshot of full rendered output
    expect(container.firstChild).toMatchSnapshot();
  });

  it("fits bounds from location.state.bounds", () => {
    useGeoSearch.mockReturnValue({
      items: [{ objectID: "1", _geoloc: { lat: 0, lng: 0 } }],
    });

    render(
      <MapContext.Provider
        value={{
          map: mockMap,
          setMap: () => {},
          mapLoaded: false,
          setMapLoaded: () => {},
        }}
      >
        <GeoSearch location={undefined} />
      </MapContext.Provider>
    );

    expect(mockFitBounds).toHaveBeenCalled();
  });

  it("fits bounds from search params", () => {
    useGeoSearch.mockReturnValue({
      items: [{ objectID: "1", _geoloc: { lat: 0, lng: 0 } }],
    });

    const location = {
      search: "?georgia_coast_places[geoSearch][boundingBox]=-81,30,-80,31",
    };

    render(
      <MapContext.Provider
        value={{
          map: mockMap,
          setMap: () => {},
          mapLoaded: false,
          setMapLoaded: () => {},
        }}
      >
        <GeoSearch location={location as any} />
      </MapContext.Provider>
    );

    expect(mockFitBounds).toHaveBeenCalled();
  });

  it("fits bounds from geojson when no state or search params", () => {
    useGeoSearch.mockReturnValue({
      items: [{ objectID: "1", _geoloc: { lat: 0, lng: 0 } }],
    });

    render(
      <MapContext.Provider value={{ map: mockMap }}>
        <GeoSearch />
      </MapContext.Provider>
    );

    expect(mockFitBounds).toHaveBeenCalled();
  });

  it("falls back to defaultBounds when no geojson features", async () => {
    const { hitsToFeatureCollection } = await vi.importMock<any>(
      "~/utils/toFeatureCollection"
    );

    hitsToFeatureCollection.mockReturnValueOnce({
      type: "FeatureCollection",
      features: [],
    });

    useGeoSearch.mockReturnValue({
      items: [{ objectID: "1", _geoloc: { lat: 0, lng: 0 } }],
    });

    render(
      <MapContext.Provider value={{ map: mockMap }}>
        <GeoSearch />
      </MapContext.Provider>
    );

    expect(mockFitBounds).toHaveBeenCalled();
  });
});
